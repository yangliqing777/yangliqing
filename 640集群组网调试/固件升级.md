# 一、源机安装ansible
ansible-core-2.13.3-1.el8.x86_64.rpm
```
sudo dnf install -y ansible-core-2.13.3-1.el8.x86_64.rpm
ansible --version
```
# 二、单机升级固件
## 1. 上传文件
fw-ConnectX6Dx-rel-22_38_1900-MCX623106AC-CDA_Ax-UEFI-14.31.20-FlexBoot-3.7.201.signed.bin
     fw-ConnectX7-rel-28_41_1000-MCX75310AAS-NEA_Ax-UEFI-14.34.12-FlexBoot-3.7.400.signed.bin
## 2. 查看当前网卡型号和固件
```
mlxup --query
```
## 3. 升级
```
mlxup -u -i /home/driver/fw-ConnectX6Dx-rel-22_43_2566-MCX623106AC-CDA_Ax-UEFI-14.37.13-FlexBoot-3.7.500.signed.bin -y
mlxup -u -i /home/driver/fw-ConnectX7-rel-28_43_2566-MCX75310AAS-NEA_Ax-UEFI-14.37.13-FlexBoot-3.7.500.signed.bin -y
```
## 4. 校验
mlxup --query
## 5. 重新加载
```
mst start
mlxfwreset --device /dev/mst/mt4129_pciconf0 --level 3 --yes r
mlxfwreset --device /dev/mst/mt4129_pciconf1 --level 3 --yes r
```
...
# 三、批量升级固件
```
---
- name: Distribute mlxup & firmware, then upgrade (CX7 -> CX6Dx) with per-phase timeouts (free + async)
  hosts: all
  gather_facts: false
  become: true
  become_user: root
  become_method: sudo
  become_flags: '-i'
  strategy: free

  vars:
    fw_dir: /home/ops
    mlxup_path: /usr/local/sbin/mlxup

    # 分机型镜像（会被拼成：-i file1 -i file2 ...）
    fw_bins_cx7:
      - fw-ConnectX7-rel-28_41_1000-MCX75310AAS-NEA_Ax-UEFI-14.34.12-FlexBoot-3.7.400.signed.bin
    fw_bins_cx6dx:
      - fw-ConnectX6Dx-rel-22_38_1900-MCX623106AC-CDA_Ax-UEFI-14.31.20-FlexBoot-3.7.201.signed.bin

    # 并发与异步
    concurrency: 128

    # —— 分阶段不同超时设置 ——
    upgrade_timeout_cx7: 7200      # CX7 单机最长秒数
    upgrade_timeout_cx6dx: 900     # CX6Dx 单机最长秒数
    poll_delay: 30                 # 轮询间隔（两阶段共用）
    poll_retries_cx7: "{{ (upgrade_timeout_cx7  // poll_delay) | int }}"
    poll_retries_cx6dx: "{{ (upgrade_timeout_cx6dx // poll_delay) | int }}"

  tasks:
    # ===== 分发阶段 =====
    - name: Ensure /usr/local/sbin exists
      file:
        path: /usr/local/sbin
        state: directory
        mode: "0755"

    - name: Copy mlxup to /usr/local/sbin
      copy:
        src: /home/driver/mlxup
        dest: /usr/local/sbin/mlxup
        mode: "0755"
        owner: root
        group: root

    - name: Ensure firmware dir exists
      file:
        path: "{{ fw_dir }}"
        state: directory
        mode: "0755"
        owner: root
        group: root

    - name: Copy firmware bin1 (CX6Dx) to targets
      copy:
        src: /home/ops/fw-ConnectX6Dx-rel-22_38_1900-MCX623106AC-CDA_Ax-UEFI-14.31.20-FlexBoot-3.7.201.signed.bin
        dest: /home/ops/fw-ConnectX6Dx-rel-22_38_1900-MCX623106AC-CDA_Ax-UEFI-14.31.20-FlexBoot-3.7.201.signed.bin
        owner: root
        group: root
        mode: "0644"

    - name: Copy firmware bin2 (CX7) to targets
      copy:
        src: /home/ops/fw-ConnectX7-rel-28_41_1000-MCX75310AAS-NEA_Ax-UEFI-14.34.12-FlexBoot-3.7.400.signed.bin
        dest: /home/ops/fw-ConnectX7-rel-28_41_1000-MCX75310AAS-NEA_Ax-UEFI-14.34.12-FlexBoot-3.7.400.signed.bin
        owner: root
        group: root
        mode: "0644"

    # ===== 升级阶段 =====
    - name: Load Mellanox modules (no-fail)
      shell: |
        modprobe mlx_compat 2>/dev/null || true
        modprobe mlx5_core 2>/dev/null || true
      args: { executable: /bin/bash }
      changed_when: false

    # -------- CX7 阶段 --------
    - name: Build -i args for CX7
      set_fact:
        fw_args_cx7: "{{ fw_bins_cx7 | map('regex_replace','^(.*)$','-i \"\\1\"') | join(' ') }}"

    - name: Kick off CX7 upgrade (force)
      when: fw_bins_cx7 | length > 0
      shell: |
        set -o pipefail
        ( "{{ mlxup_path }}" -u {{ fw_args_cx7 }} -y -f ) 2>&1
      args:
        chdir: "{{ fw_dir }}"
        executable: /bin/bash
      async: "{{ upgrade_timeout_cx7 }}"
      poll: 0
      register: mlxup_async_cx7
      throttle: "{{ concurrency }}"

    - name: Wait CX7 upgrade to finish
      when: fw_bins_cx7 | length > 0
      async_status:
        jid: "{{ mlxup_async_cx7.ansible_job_id }}"
      register: mlxup_result_cx7
      until: mlxup_result_cx7.finished
      retries: "{{ poll_retries_cx7 }}"
      delay: "{{ poll_delay }}"
      failed_when: >
        (mlxup_result_cx7.rc is defined and mlxup_result_cx7.rc != 0) and not (
          (mlxup_result_cx7.stdout is defined) and (
            'Up to date' in mlxup_result_cx7.stdout or
            'Update required' in mlxup_result_cx7.stdout or
            'Forced update required' in mlxup_result_cx7.stdout or
            'pending reset' in mlxup_result_cx7.stdout or
            'already updated on flash' in mlxup_result_cx7.stdout or
            'No matching image found' in mlxup_result_cx7.stdout
          )
        )

    - name: Show CX7 result
      when: fw_bins_cx7 | length > 0 and (mlxup_result_cx7.stdout is defined)
      debug:
        var: mlxup_result_cx7.stdout

    # -------- CX6Dx 阶段 --------
    - name: Build -i args for CX6Dx
      set_fact:
        fw_args_cx6dx: "{{ fw_bins_cx6dx | map('regex_replace','^(.*)$','-i \"\\1\"') | join(' ') }}"

    - name: Kick off CX6Dx upgrade (force)
      when: fw_bins_cx6dx | length > 0
      shell: |
        set -o pipefail
        ( "{{ mlxup_path }}" -u {{ fw_args_cx6dx }} -y -f ) 2>&1
      args:
        chdir: "{{ fw_dir }}"
        executable: /bin/bash
      async: "{{ upgrade_timeout_cx6dx }}"
      poll: 0
      register: mlxup_async_cx6
      throttle: "{{ concurrency }}"

    - name: Wait CX6Dx upgrade to finish
      when: fw_bins_cx6dx | length > 0
      async_status:
        jid: "{{ mlxup_async_cx6.ansible_job_id }}"
      register: mlxup_result_cx6
      until: mlxup_result_cx6.finished
      retries: "{{ poll_retries_cx6dx }}"
      delay: "{{ poll_delay }}"
      failed_when: >
        (mlxup_result_cx6.rc is defined and mlxup_result_cx6.rc != 0) and not (
          (mlxup_result_cx6.stdout is defined) and (
            'Up to date' in mlxup_result_cx6.stdout or
            'Update required' in mlxup_result_cx6.stdout or
            'Forced update required' in mlxup_result_cx6.stdout or
            'pending reset' in mlxup_result_cx6.stdout or
            'already updated on flash' in mlxup_result_cx6.stdout or
            'No matching image found' in mlxup_result_cx6.stdout
          )
        )

    - name: Show CX6Dx result
      when: fw_bins_cx6dx | length > 0 and (mlxup_result_cx6.stdout is defined)
      debug:
        var: mlxup_result_cx6.stdout
```

包括 分发mlxup、分发固件bin文件、modprobe、升级cx7、升级cx6
其中升级命令为 mlxup -u -i cx6.bin -f -y
-u表示升级、-i指定bin文件、-f表示强制（可降级）、-y表示yes
```
ansible-playbook -i hosts.ini all.yml -f 128
```
# 四、批量查询版本生成csv文件
```
# check_nic_fw_min.yml
- name: Batch query NIC firmware versions to ONE CSV (Device #1..#10 FW)
  hosts: all
  gather_facts: false
  become: true
  strategy: free

  vars:
    logdir_local: /home/driver/logs                  # 结果目录
    csv_path: "{{ logdir_local }}/nic_fw_latest.csv" # 固定一个CSV文件名
    mlxup_path: /usr/local/sbin/mlxup                # mlxup 绝对路径
    host_ip: "{{ hostvars[inventory_hostname].ansible_host | default(inventory_hostname) }}"

  pre_tasks:
    - name: Create log directory on controller
      delegate_to: localhost
      become: false
      when: inventory_hostname == groups['all'][0]
      file:
        path: "{{ logdir_local }}"
        state: directory
        mode: "0755"

    - name: Initialize CSV header (overwrite each run)
      delegate_to: localhost
      become: false
      when: inventory_hostname == groups['all'][0]
      copy:
        dest: "{{ csv_path }}"
        mode: "0644"
        force: true
        content: "ip,dev1,dev2,dev3,dev4,dev5,dev6,dev7,dev8,dev9,dev10\n"

  tasks:
    - name: (Optional) load mlx kernel modules (no-fail)
      shell: |
        modprobe mlx_compat 2>/dev/null || true
        modprobe mlx5_core 2>/dev/null || true
      args: { executable: /bin/bash }
      changed_when: false

    - name: Query & parse FW versions (Device #1..#10) on remote
      shell: |
        set -o pipefail
        ( "{{ mlxup_path }}" --query 2>/dev/null || true ) | awk '
          BEGIN{
            max=10; for(i=1;i<=max;i++) fw[i]=""; dev=0
          }
          /^Device #[0-9]+:/{
            if (match($0, /Device #([0-9]+)/, m)) dev=m[1]; next
          }
          # 仅抓取"FW <version>"，跳过"FW (Running) <version>"
          /^[[:space:]]*FW[[:space:]]/{
            if ($2=="(Running)") next
            if (dev>=1 && dev<=max) {
              ver=""
              for (i=1;i<=NF;i++){
                if ($i ~ /^[0-9]+(\.[0-9]+){2,3}$/) { ver=$i; break }
              }
              fw[dev]=ver
            }
            next
          }
          END{
            for (i=1;i<=max;i++){
              if (i>1) printf(",")
              printf("%s", fw[i])
            }
            printf("\n")
          }'
      args: { executable: /bin/bash }
      register: fw_cols
      changed_when: false

    - name: Compose one CSV row for this host
      set_fact:
        csv_row: "{{ host_ip }},{{ (fw_cols.stdout | default(',,,,,,,,,,')) | trim }}"

    - name: Append row to the single CSV on controller (serialized writer)
      delegate_to: localhost
      become: false
      throttle: 1
      shell: |
        printf '%s\n' "{{ csv_row }}" >> "{{ csv_path }}"
      args: { executable: /bin/bash }

  post_tasks:
    - name: Sort CSV by IP ascending (keep header on top)
      delegate_to: localhost
      become: false
      when: inventory_hostname == groups['all'][0]
      shell: |
        set -euo pipefail
        tmp="$(mktemp)"
        { head -n1 "{{ csv_path }}"; tail -n +2 "{{ csv_path }}" | sort -t, -k1,1V; } > "$tmp"
        cp -f "$tmp" "{{ csv_path }}"
        rm -f "$tmp"
      args: { executable: /bin/bash }

    - name: Show CSV path
      delegate_to: localhost
      become: false
      when: inventory_hostname == groups['all'][0]
      debug:
        msg: "NIC FW CSV written & sorted: {{ csv_path }}"
```
```
ansible-playbook -i hosts_all.ini query_fw.yml -f 128
cat /home/driver/logs/nic_fw_latest.csv
```
# 五、重新加载固件版本
```
# mlxfwreset.yml
- hosts: all:!source
  gather_facts: no
  become: true
  tasks:
    - name: Start mst
      command: mst start
      async: 60
      poll: 0

    - pause:
        seconds: 30

    - name: Reset mt4129_pciconf0
      command: mlxfwreset --device /dev/mst/mt4129_pciconf0 --level 3 --yes r
      async: 60
      poll: 0

    - pause:
        seconds: 30

    - name: Reset mt4129_pciconf1
      command: mlxfwreset --device /dev/mst/mt4129_pciconf1 --level 3 --yes r
      async: 60
      poll: 0

    - pause:
        seconds: 30

    - name: Reset mt4129_pciconf2
      command: mlxfwreset --device /dev/mst/mt4129_pciconf2 --level 3 --yes r
      async: 60
      poll: 0

    - pause:
        seconds: 30

    - name: Reset mt4129_pciconf3
      command: mlxfwreset --device /dev/mst/mt4129_pciconf3 --level 3 --yes r
      async: 60
      poll: 0

    - pause:
        seconds: 30

    - name: Reset mt4129_pciconf4
      command: mlxfwreset --device /dev/mst/mt4129_pciconf4 --level 3 --yes r
      async: 60
      poll: 0

    - pause:
        seconds: 30

    - name: Reset mt4129_pciconf5
      command: mlxfwreset --device /dev/mst/mt4129_pciconf5 --level 3 --yes r
      async: 60
      poll: 0

    - pause:
        seconds: 30

    - name: Reset mt4129_pciconf6
      command: mlxfwreset --device /dev/mst/mt4129_pciconf6 --level 3 --yes r
      async: 60
      poll: 0

    - pause:
        seconds: 30

    - name: Reset mt4129_pciconf7
      command: mlxfwreset --device /dev/mst/mt4129_pciconf7 --level 3 --yes r
      async: 60
      poll: 0

    - pause:
        seconds: 30

    - name: Reset mt4125_pciconf0
      command: mlxfwreset --device /dev/mst/mt4125_pciconf0 --level 3 --yes r
      async: 60
      poll: 0
```
